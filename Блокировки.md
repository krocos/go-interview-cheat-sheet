# Типы блокировок
## По уровню гранулярности
- **Табличные (table locks)** — Блокировка всей таблицы.
    - Пример: `LOCK TABLE accounts IN ACCESS EXCLUSIVE MODE` (PostgreSQL).
    - **Минусы**: Низкая параллельность, другие транзакции ждут.
- **Строковые (row locks)** — Блокировка только конкретных строк.
    - Пример: `SELECT * FROM accounts WHERE id = 1 FOR UPDATE`.
    - **Плюсы**: Высокая параллельность, блокируется только нужная строка.
- **Ячейки (page locks)** — Блокировка страницы памяти (редко используется).
## По типу доступа
### Пессимистичные блокировки (pessimistic locks)
- Блокировка **до изменения данных** (предполагаем худший сценарий).
- Пример: `SELECT FOR UPDATE` в SQL.
```sql
BEGIN;
SELECT * FROM orders WHERE user_id = 10 FOR UPDATE; -- Блокировка строк
UPDATE orders SET status = 'processed' WHERE user_id = 10;
COMMIT;
```
- **Когда использовать**: Когда высока конкуренция за данные (например, банковские транзакции).
### Оптимистичные блокировки (optimistic locks)
- Проверка **после изменения** (через версии или временные метки).
- Пример:
```sql
UPDATE products 
SET stock = stock - 1, version = version + 1 
WHERE id = 5 AND version = 2; -- Проверяем, что версия не изменилась
```
- **Когда использовать**: Когда конфликты редки (например, редактирование профиля пользователя).
# Проблемы из-за блокировок
## Взаимоблокировка (Deadlock)
Когда две транзакции блокируют ресурсы в разном порядке:
```sql
-- Транзакция 1
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1; -- Блокирует строку id=1
UPDATE accounts SET balance = balance + 100 WHERE id = 2; -- Ждёт, пока транзакция 2 отпустит id=2

-- Транзакция 2
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE id = 2; -- Блокирует строку id=2
UPDATE accounts SET balance = balance + 50 WHERE id = 1; -- Ждёт, пока транзакция 1 отпустит id=1
```
**Решение**:
- СУБД автоматически обнаруживает deadlock и отменяет одну из транзакций.
- Можно избежать, блокируя ресурсы **в одинаковом порядке**.
## Голодание (Starvation)
Одна транзакция постоянно проигрывает в конкуренции за блокировки.  
**Решение**: Использовать очереди или fair locks.