# –ü–∞—Ä—Ç–∏—Ü–∏–∏ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
**–í–∞–∂–Ω–æ**: –í Kafka —Ç–æ–ø–∏–∫–∏ —Å–∞–º–∏ –ø–æ —Å–µ–±–µ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç "–æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å" –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –ø–æ–Ω–∏–º–∞–Ω–∏–∏ ‚Äì –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –ø–∞—Ä—Ç–∏—Ü–∏–∏.

- **–ü–∞—Ä—Ç–∏—Ü–∏—è (Partition)**¬†‚Äì –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –≤ Kafka.
    - –î–∞–Ω–Ω—ã–µ –≤ —Ç–æ–ø–∏–∫–µ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ (–∫–∞–∫ —à–∞—Ä–¥—ã –≤ –ë–î).
    - **–ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏.**
    - –ï—Å–ª–∏ –≤–∞–∂–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫, —Ç–æ –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á (`key`), —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—Ü–∏—é.
- **Replication Factor**¬†‚Äì –∫–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±—Ä–æ–∫–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.
# Consumer Groups
Kafka —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Ç–æ–ø–∏–∫–∞ –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏ –≤ –≥—Ä—É–ø–ø–µ.

–í Kafka¬†**—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–æ–ø–∏–∫–∞ –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏ (consumer) –≤ –≥—Ä—É–ø–ø–µ**¬†‚Äì —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∫–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è —Ç–æ–ø–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ¬†**–æ–¥–Ω–æ–º—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é**¬†–∏–∑ –≥—Ä—É–ø–ø—ã. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.

- –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π **–±–æ–ª—å—à–µ**, —á–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–π ‚Äì —á–∞—Å—Ç—å –±—É–¥–µ—Ç –±–µ–∑ —Ä–∞–±–æ—Ç—ã.
- –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –ø–∞–¥–∞–µ—Ç ‚Äì –µ–≥–æ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è (rebalance).
- –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π¬†**–º–µ–Ω—å—à–µ**, —á–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–π, —Ç–æ –æ–¥–Ω–æ–º—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é –¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è¬†**–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä—Ç–∏—Ü–∏–π**.
## –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å
- **–û–¥–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å = –æ–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä—Ç–∏—Ü–∏–π**¬†(–Ω–æ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç).
- **Rebalance**¬†–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–∏—Å–ª–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π.
- **–ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π**¬†–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –ø–∞—Ä—Ç–∏—Ü–∏–∏.
# –ì–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Kafka
Kafka –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
## ‚úÖ Exactly once (—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑)
- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑**, –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
- –î–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é:
  - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ (`enable.idempotence=true`)
  - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (`initTransactions`, `beginTransaction`, `commitTransaction`)
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞.
- –°–∞–º–∞—è –Ω–∞–¥—ë–∂–Ω–∞—è, –Ω–æ –∏ —Å–∞–º–∞—è –∑–∞—Ç—Ä–∞—Ç–Ω–∞—è –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º –≥–∞—Ä–∞–Ω—Ç–∏—è.
## üîÅ At least once (–ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ –æ–¥–∏–Ω —Ä–∞–∑)
- –°–æ–æ–±—â–µ–Ω–∏–µ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ**, –Ω–æ **–≤–æ–∑–º–æ–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**.
- –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ –ø—Ä–æ–¥—é—Å–µ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –ø–æ–ª—É—á–∏–ª ack).
- –¢—Ä–µ–±—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–Ω—Å—é–º–µ—Ä–∞.
- **–≠—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ Kafka** (–ø—Ä–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö).
## ‚ùó At most once (–Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞)
- –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å **–ø–æ—Ç–µ—Ä—è–Ω–æ**, –Ω–æ **–¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –±—É–¥–µ—Ç**.
- –ë—ã—Å—Ç—Ä–∞—è, –Ω–æ –Ω–µ–Ω–∞–¥–µ–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Äî –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.
## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–¥—é—Å–µ—Ä–∞, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—é:
- `acks=0` ‚Üí **at most once**
- `acks=1` ‚Üí **at least once** (—Ç–æ–ª—å–∫–æ –æ—Ç –ª–∏–¥–µ—Ä–∞)
- `acks=all` ‚Üí **at least once**, –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ (–≤—Å–µ —Ä–µ–ø–ª–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç)
# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Kafka
## –ß—Ç–æ —Ç–∞–∫–æ–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Kafka –ø–æ–∑–≤–æ–ª—è—é—Ç:
- –æ—Ç–ø—Ä–∞–≤–∏—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–ø–∏–∫–æ–≤ –∫–∞–∫ –æ–¥–Ω–æ —Ü–µ–ª–æ–µ**;
- –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –ª–∏–±–æ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã, –ª–∏–±–æ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ;
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å **exactly once delivery**.
## –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –∏ —Ç–æ–ø–∏–∫–∞–º–∏.
- –ò—Å–∫–ª—é—á–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–±–æ—è—Ö.
- –°—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Kafka Streams).
## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?
1Ô∏è‚É£ –ü—Ä–æ–¥—é—Å–µ—Ä —Å–æ–∑–¥–∞—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
```go
producer.InitTransactions()
```
2Ô∏è‚É£ –ù–∞—á–∏–Ω–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
```go
producer.BeginTransaction()
```
3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –æ–±—ã—á–Ω–æ:
```go
producer.Send()
```
4Ô∏è‚É£ –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
- –∫–æ–º–º—Ç
```go
producer.CommitTransaction()
```
- –∏–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç
```go
producer.AbortTransaction()
```
## –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?
- –í–∫–ª—é—á—ë–Ω¬†**–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä**¬†(`enable.idempotence=true`)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π¬†`transactional.id`¬†—É –ø—Ä–æ–¥—é—Å–µ—Ä–∞
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—Ä–æ–∫–µ—Ä–∞:
    - `transaction.state.log.replication.factor`
    - `transaction.state.log.min.isr`
## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤ (–∏ Kafka Streams).
- –°–ª–æ–∂–Ω–µ–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å.
- –ù–µ–±–æ–ª—å—à–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∏–∑-–∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
- –¢—Ä–µ–±—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞ –∫ –±—Ä–æ–∫–µ—Ä—É.
